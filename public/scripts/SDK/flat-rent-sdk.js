const database = [
    {
        id: 'vnd331',
        title: 'Radisson Royal Hotel',
        details: 'Отель расположен в 4 минутах ходьбы от станции метро «Маяковская». К услугам гостей фитнес-центр и спа-центр с сауной и гидромассажной ванной.',
        photos: ['vnd331.png', 'vnd331.png'],
        coordinates: [59.9322936, 30.3460129],
        bookedDates: [],
        price: 12000,
    },
    {
        id: 'ab2e2',
        title: 'Номера на Садовой',
        details: 'Расположен в 7 минутах ходьбы от Невского проспекта. К услугам гостей круглосуточная стойка регистрации и бесплатный Wi-Fi.',
        photos: ['ab2e2.png', 'ab2e2.png'],
        coordinates: [59.930325, 30.3291592],
        bookedDates: [],
        price: 4500,
    },
    {
        id: 'mvm32l',
        title: 'Мини Отель на Невском 136',
        details: 'Мини-отель расположен в Санкт-Петербурге, в 5 минутах ходьбы от станции метро «Площадь Восстания» и Московского железнодорожного вокзала.',
        photos: ['mvm32l.png', 'mvm32l.png'],
        coordinates: [59.9299603, 30.3658932],
        bookedDates: [],
        price: 3800,
    },
    {
        id: 'bvep12',
        title: 'Отель Усадьба Державина',
        details: 'Прекрасный отель недалеко от Исаакиевского собора с бесплатным Wi-Fi на всей территории.',
        photos: ['bvep12.png', 'bvep12.png'],
        coordinates: [59.9194966, 30.309389],
        bookedDates: [],
        price: 8700,
    },
];
export function cloneDate(date) {
    return new Date(date.getTime());
}
export function addDays(date, days) {
    date.setDate(date.getDate() + days);
    return date;
}
export const backendPort = 3040;
export const localStorageKey = 'flat-rent-db';
export class FlatRentSdk {
    constructor() {
        this._generateTransactionId = () => {
            const min = 1000;
            const max = 9999;
            const num = Math.random() * (max - min) + min;
            return Math.floor(num);
        };
        if (this._readDatabase() == null) {
            this._writeDatabase(database);
        }
        this.database = this._readDatabase();
    }
    /**
     * Get flat by ID.
     *
     * @param {string} id Flat ID.
     * @returns {Promise<Object|null>} Flat.
     */
    get(id) {
        const flat = this.database.find((item) => {
            return item.id === id;
        });
        return Promise.resolve(flat == null ? flat : this._formatFlatObject(flat));
    }
    /**
     * Search for flats.
     *
     * @param {Object} parameters Search parameters
     * @param {string}parameters.city City name
     * @param {Date} parameters.checkInDate Check-in date
     * @param {Date} parameters.checkOutDate Check-out date
     * @param {number} [parameters.priceLimit] Max price for a night
     * @returns {Object[]} List of suitable flats.
     */
    search(parameters) {
        return new Promise((resolve, reject) => {
            try {
                if (parameters.city != 'Санкт-Петербург') {
                    throw new Error(`Passed unsupported city - "${parameters.city}".`);
                }
                if (!(parameters.checkInDate instanceof Date) ||
                    !(parameters.checkOutDate instanceof Date)) {
                    throw new Error(`Passed invalid check-in or check-out date - from "${parameters.checkInDate}" to "${parameters.checkOutDate}".`);
                }
                this._assertDatesAreCorrect(parameters.checkInDate, parameters.checkOutDate);
                if (parameters.priceLimit != null &&
                    (isNaN(parameters.priceLimit) || !isFinite(parameters.priceLimit))) {
                    throw new Error(`Passed invalid price limit - "${parameters.priceLimit}".`);
                }
                let flats = this.database;
                if (parameters.priceLimit != null) {
                    flats = flats.filter((flat) => {
                        return flat.price <= parameters.priceLimit;
                    });
                }
                const dateRange = this._generateDateRange(parameters.checkInDate, parameters.checkOutDate);
                flats = flats.filter((flat) => {
                    return this._areAllDatesAvailable(flat, dateRange);
                });
                flats = flats.map((flat) => {
                    return this._formatFlatObject(flat, dateRange.length - 1);
                });
                resolve(flats);
            }
            catch (error) {
                reject(error);
            }
        });
    }
    /**
     * Book flat.
     *
     * @param {number} flatId
     * @param {Date} checkInDate
     * @param {Date} checkOutDate
     * @returns {number}
     */
    book(flatId, checkInDate, checkOutDate) {
        return new Promise((resolve, reject) => {
            try {
                const flat = this.database.find((item) => {
                    return item.id === flatId;
                });
                if (flat == null) {
                    throw new Error('There is no flat with ID "' + flatId + '".');
                }
                this._assertDatesAreCorrect(checkInDate, checkOutDate);
                const datesToBook = this._generateDateRange(checkInDate, checkOutDate);
                if (!this._areAllDatesAvailable(flat, datesToBook)) {
                    throw new Error(`Flat ${flat.id} is not available for dates ${datesToBook.join(',')}.`);
                }
                const bookedDates = datesToBook.map((date) => {
                    return date.getTime();
                });
                flat.bookedDates.push(...bookedDates);
                for (let i = 0; i < this.database.length; i++) {
                    if (this.database[i].id === flat.id) {
                        this.database[i] = flat;
                        break;
                    }
                }
                this._writeDatabase(this.database);
                resolve(this._generateTransactionId());
            }
            catch (error) {
                reject(error);
            }
        });
    }
    _assertDatesAreCorrect(checkInDate, checkOutDate) {
        const today = new Date();
        this._resetTime(today);
        this._resetTime(checkInDate);
        this._resetTime(checkOutDate);
        const diffToday = this._calculateDifferenceInDays(today, checkInDate);
        if (diffToday < 0) {
            throw new Error("Check-in date can't be in the past.");
        }
        const diffCheck = this._calculateDifferenceInDays(checkInDate, checkOutDate);
        if (diffCheck < 0) {
            throw new Error('Check-out date must be grater then check-in date.');
        }
    }
    _resetTime(date) {
        date.setHours(0);
        date.setMinutes(0);
        date.setSeconds(0);
        date.setMilliseconds(0);
    }
    _calculateDifferenceInDays(startDate, endDate) {
        const difference = endDate.getTime() - startDate.getTime();
        return Math.floor(difference / (1000 * 60 * 60 * 24));
    }
    _generateDateRange(from, to) {
        const dates = [];
        const differenceInDays = this._calculateDifferenceInDays(from, to);
        dates.push(new Date(from.getFullYear(), from.getMonth(), from.getDate()));
        for (let i = 1; i <= differenceInDays; i++) {
            dates.push(new Date(from.getFullYear(), from.getMonth(), from.getDate() + i));
        }
        return dates;
    }
    _areAllDatesAvailable(flat, dateRange) {
        return dateRange.every((date) => {
            return !flat.bookedDates.includes(date.getTime());
        });
    }
    _formatFlatObject(flat, nightNumber) {
        const formattedFlat = Object.assign({}, flat);
        formattedFlat.photos = formattedFlat.photos.map((photoUrl) => {
            return `http://localhost:${backendPort}/img/${photoUrl}`;
        });
        if (nightNumber != null) {
            formattedFlat.totalPrice = nightNumber * formattedFlat.price;
            delete formattedFlat.price;
        }
        return formattedFlat;
    }
    _readDatabase() {
        const data = window.localStorage.getItem(localStorageKey);
        if (data == null) {
            return data;
        }
        return JSON.parse(data);
    }
    _writeDatabase(database) {
        window.localStorage.setItem(localStorageKey, JSON.stringify(database));
    }
    _syncDatabase(database) {
        this._writeDatabase(database);
        this.database = this._readDatabase();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmxhdC1yZW50LXNkay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9TREsvZmxhdC1yZW50LXNkay5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxNQUFNLFFBQVEsR0FBRztJQUNmO1FBQ0UsRUFBRSxFQUFFLFFBQVE7UUFDWixLQUFLLEVBQUUsc0JBQXNCO1FBQzdCLE9BQU8sRUFDTCxnSkFBZ0o7UUFDbEosTUFBTSxFQUFFLENBQUMsWUFBWSxFQUFFLFlBQVksQ0FBQztRQUNwQyxXQUFXLEVBQUUsQ0FBQyxVQUFVLEVBQUUsVUFBVSxDQUFDO1FBQ3JDLFdBQVcsRUFBRSxFQUFFO1FBQ2YsS0FBSyxFQUFFLEtBQUs7S0FDYjtJQUNEO1FBQ0UsRUFBRSxFQUFFLE9BQU87UUFDWCxLQUFLLEVBQUUsbUJBQW1CO1FBQzFCLE9BQU8sRUFDTCw2SEFBNkg7UUFDL0gsTUFBTSxFQUFFLENBQUMsV0FBVyxFQUFFLFdBQVcsQ0FBQztRQUNsQyxXQUFXLEVBQUUsQ0FBQyxTQUFTLEVBQUUsVUFBVSxDQUFDO1FBQ3BDLFdBQVcsRUFBRSxFQUFFO1FBQ2YsS0FBSyxFQUFFLElBQUk7S0FDWjtJQUNEO1FBQ0UsRUFBRSxFQUFFLFFBQVE7UUFDWixLQUFLLEVBQUUsMkJBQTJCO1FBQ2xDLE9BQU8sRUFDTCwySUFBMkk7UUFDN0ksTUFBTSxFQUFFLENBQUMsWUFBWSxFQUFFLFlBQVksQ0FBQztRQUNwQyxXQUFXLEVBQUUsQ0FBQyxVQUFVLEVBQUUsVUFBVSxDQUFDO1FBQ3JDLFdBQVcsRUFBRSxFQUFFO1FBQ2YsS0FBSyxFQUFFLElBQUk7S0FDWjtJQUNEO1FBQ0UsRUFBRSxFQUFFLFFBQVE7UUFDWixLQUFLLEVBQUUseUJBQXlCO1FBQ2hDLE9BQU8sRUFDTCwwRkFBMEY7UUFDNUYsTUFBTSxFQUFFLENBQUMsWUFBWSxFQUFFLFlBQVksQ0FBQztRQUNwQyxXQUFXLEVBQUUsQ0FBQyxVQUFVLEVBQUUsU0FBUyxDQUFDO1FBQ3BDLFdB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TSxhQUFhLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUE7UUFFN0MsYUFBYSxDQUFDLE1BQU0sR0FBRyxhQUFhLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLFFBQVEsRUFBRSxFQUFFO1lBQzNELE9BQU8sb0JBQW9CLFdBQVcsUUFBUSxRQUFRLEVBQUUsQ0FBQTtRQUMxRCxDQUFDLENBQUMsQ0FBQTtRQUVGLElBQUksV0FBVyxJQUFJLElBQUksRUFBRTtZQUN2QixhQUFhLENBQUMsVUFBVSxHQUFHLFdBQVcsR0FBRyxhQUFhLENBQUMsS0FBSyxDQUFBO1lBQzVELE9BQU8sYUFBYSxDQUFDLEtBQUssQ0FBQTtTQUMzQjtRQUVELE9BQU8sYUFBYSxDQUFBO0lBQ3RCLENBQUM7SUFFRCxhQUFhO1FBQ1gsTUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUE7UUFFekQsSUFBSSxJQUFJLElBQUksSUFBSSxFQUFFO1lBQ2hCLE9BQU8sSUFBSSxDQUFBO1NBQ1o7UUFFRCxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUE7SUFDekIsQ0FBQztJQUVELGNBQWMsQ0FBQyxRQUFRO1FBQ3JCLE1BQU0sQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLGVBQWUsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUE7SUFDeEUsQ0FBQztJQUVELGFBQWEsQ0FBQyxRQUFRO1FBQ3BCLElBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLENBQUE7UUFDN0IsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUE7SUFDdEMsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgZGF0YWJhc2UgPSBbXG4gIHtcbiAgICBpZDogJ3ZuZDMzMScsXG4gICAgdGl0bGU6ICdSYWRpc3NvbiBSb3lhbCBIb3RlbCcsXG4gICAgZGV0YWlsczpcbiAgICAgICfQntGC0LXQu9GMINGA0LDRgdC/0L7Qu9C+0LbQtdC9INCyIDQg0LzQuNC90YPRgtCw0YUg0YXQvtC00YzQsdGLINC+0YIg0YHRgtCw0L3RhtC40Lgg0LzQtdGC0YDQviDCq9Cc0LDRj9C60L7QstGB0LrQsNGPwrsuINCaINGD0YHQu9GD0LPQsNC8INCz0L7RgdGC0LXQuSDRhNC40YLQvdC10YEt0YbQtdC90YLRgCDQuCDRgdC/0LAt0YbQtdC90YLRgCDRgSDRgdCw0YPQvdC+0Lkg0Lgg0LPQuNC00YDQvtC80LDRgdGB0LDQttC90L7QuSDQstCw0L3QvdC+0LkuJyxcbiAgICBwaG90b3M6IFsndm5kMzMxLnBuZycsICd2bmQzMzEucG5nJ10sXG4gICAgY29vcmRpbmF0ZXM6IFs1OS45MzIyOTM2LCAzMC4zNDYwMTI5XSxcbiAgICBib29rZWREYXRlczogW10sXG4gICAgcHJpY2U6IDEyMDAwLFxuICB9LFxuICB7XG4gICAgaWQ6ICdhYjJlMicsXG4gICAgdGl0bGU6ICfQndC+0LzQtdGA0LAg0L3QsCDQodCw0LTQvtCy0L7QuScsXG4gICAgZGV0YWlsczpcbiAgICAgICfQoNCw0YHQv9C+0LvQvtC20LXQvSDQsiA3INC80LjQvdGD0YLQsNGFINGF0L7QtNGM0LHRiyDQvtGCINCd0LXQstGB0LrQvtCz0L4g0L/RgNC+0YHQv9C10LrRgtCwLiDQmiDRg9GB0LvRg9Cz0LDQvCDQs9C+0YHRgtC10Lkg0LrRgNGD0LPQu9C+0YHRg9GC0L7Rh9C90LDRjyDRgdGC0L7QudC60LAg0YDQtdCz0LjRgdGC0YDQsNGG0LjQuCDQuCDQsdC10YHQv9C70LDRgtC90YvQuSBXaS1GaS4nLFxuICAgIHBob3RvczogWydhYjJlMi5wbmcnLCAnYWIyZTIucG5nJ10sXG4gICAgY29vcmRpbmF0ZXM6IFs1OS45MzAzMjUsIDMwLjMyOTE1OTJdLFxuICAgIGJvb2tlZERhdGVzOiBbXSxcbiAgICBwcmljZTogNDUwMCxcbiAgfSxcbiAge1xuICAgIGlkOiAnbXZtMzJsJyxcbiAgICB0aXRsZTogJ9Cc0LjQvdC4INCe0YLQtdC70Ywg0L3QsCDQndC10LLRgdC60L7QvCAxMzYnLFxuICAgIGRldGFpbHM6XG4gICAgICAn0JzQuNC90Lgt0L7RgtC10LvRjCDRgNCw0YHQv9C+0LvQvtC20LXQvSDQsiDQodCw0L3QutGCLdCf0LXRgtC10YDQsdGD0YDQs9C1LCDQsiA1INC80LjQvdGD0YLQsNGFINGF0L7QtNGM0LHRiyDQvtGCINGB0YLQsNC90YbQuNC4INC80LXRgtGA0L4gwqvQn9C70L7RidCw0LTRjCDQktC+0YHRgdGC0LDQvdC40Y/CuyDQuCDQnNC+0YHQutC+0LLRgdC60L7Qs9C+INC20LXQu9C10LfQvdC+0LTQvtGA0L7QttC90L7Qs9C+INCy0L7QutC30LDQu9CwLicsXG4gICAgcGhvdG9zOiBbJ212bTMybC5wbmcnLCAnbXZtMzJsLnBuZyddLFxuICAgIGNvb3JkaW5hdGVzOiBbNTkuOTI5OTYwMywgMzAuMzY1ODkzMl0sXG4gICAgYm9va2VkRGF0ZXM6IFtdLFxuICAgIHByaWNlOiAzODAwLFxuICB9LFxuICB7XG4gICAgaWQ6ICdidmVwMTInLFxuICAgIHRpdGxlOiAn0J7RgtC10LvRjCDQo9GB0LDQtNGM0LHQsCDQlNC10YDQttCw0LLQuNC90LAnLFxuICAgIGRldGFpbHM6XG4gICAgICAn0J/RgNC10LrRgNCw0YHQvdGL0Lkg0L7RgtC10LvRjCDQvdC10LTQsNC70LXQutC+INC+0YIg0JjRgdCw0LDQutC40LXQstGB0LrQvtCz0L4g0YHQvtCx0L7RgNCwINGBINCx0LXRgdC/0LvQsNGC0L3Ri9C8IFdpLUZpINC90LAg0LLRgdC10Lkg0YLQtdGA0YDQuNGC0L7RgNC40LguJyxcbiAgICBwaG90b3M6IFsnYnZlcDEyLnBuZycsICdidmVwMTIucG5nJ10sXG4gICAgY29vcmRpbmF0ZXM6IFs1OS45MTk0OTY2LCAzMC4zMDkzODldLFxuICAgIGJvb2tlZERhdGVzOiBbXSxcbiAgICBwcmljZTogODcwMCxcbiAgfSxcbl1cblxuZXhwb3J0IGZ1bmN0aW9uIGNsb25lRGF0ZShkYXRlKSB7XG4gIHJldHVybiBuZXcgRGF0ZShkYXRlLmdldFRpbWUoKSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGFkZERheXMoZGF0ZSwgZGF5cykge1xuICBkYXRlLnNldERhdGUoZGF0ZS5nZXREYXRlKCkgKyBkYXlzKVxuICByZXR1cm4gZGF0ZVxufVxuXG5leHBvcnQgY29uc3QgYmFja2VuZFBvcnQgPSAzMDQwXG5leHBvcnQgY29uc3QgbG9jYWxTdG9yYWdlS2V5ID0gJ2ZsYXQtcmVudC1kYidcblxuZXhwb3J0IGNsYXNzIEZsYXRSZW50U2RrIHtcbiAgY29uc3RydWN0b3IoKSB7XG4gICAgaWYgKHRoaXMuX3JlYWREYXRhYmFzZSgpID09IG51bGwpIHtcbiAgICAgIHRoaXMuX3dyaXRlRGF0YWJhc2UoZGF0YWJhc2UpXG4gICAgfVxuXG4gICAgdGhpcy5kYXRhYmFzZSA9IHRoaXMuX3JlYWREYXRhYmFzZSgpXG4gIH1cblxuICAvKipcbiAgICogR2V0IGZsYXQgYnkgSUQuXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBpZCBGbGF0IElELlxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxPYmplY3R8bnVsbD59IEZsYXQuXG4gICAqL1xuICBnZXQoaWQpIHtcbiAgICBjb25zdCBmbGF0ID0gdGhpcy5kYXRhYmFzZS5maW5kKChpdGVtKSA9PiB7XG4gICAgICByZXR1cm4gaXRlbS5pZCA9PT0gaWRcbiAgICB9KVxuXG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShmbGF0ID09IG51bGwgPyBmbGF0IDogdGhpcy5fZm9ybWF0RmxhdE9iamVjdChmbGF0KSlcbiAgfVxuXG4gIC8qKlxuICAgKiBTZWFyY2ggZm9yIGZsYXRzLlxuICAgKlxuICAgKiBAcGFyYW0ge09iamVjdH0gcGFyYW1ldGVycyBTZWFyY2ggcGFyYW1ldGVyc1xuICAgKiBAcGFyYW0ge3N0cmluZ31wYXJhbWV0ZXJzLmNpdHkgQ2l0eSBuYW1lXG4gICAqIEBwYXJhbSB7RGF0ZX0gcGFyYW1ldGVycy5jaGVja0luRGF0ZSBDaGVjay1pbiBkYXRlXG4gICAqIEBwYXJhbSB7RGF0ZX0gcGFyYW1ldGVycy5jaGVja091dERhdGUgQ2hlY2stb3V0IGRhdGVcbiAgICogQHBhcmFtIHtudW1iZXJ9IFtwYXJhbWV0ZXJzLnByaWNlTGltaXRdIE1heCBwcmljZSBmb3IgYSBuaWdodFxuICAgKiBAcmV0dXJucyB7T2JqZWN0W119IExpc3Qgb2Ygc3VpdGFibGUgZmxhdHMuXG4gICAqL1xuICBzZWFyY2gocGFyYW1ldGVycykge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBpZiAocGFyYW1ldGVycy5jaXR5ICE9ICfQodCw0L3QutGCLdCf0LXRgtC10YDQsdGD0YDQsycpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFBhc3NlZCB1bnN1cHBvcnRlZCBjaXR5IC0gXCIke3BhcmFtZXRlcnMuY2l0eX1cIi5gKVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKFxuICAgICAgICAgICEocGFyYW1ldGVycy5jaGVja0luRGF0ZSBpbnN0YW5jZW9mIERhdGUpIHx8XG4gICAgICAgICAgIShwYXJhbWV0ZXJzLmNoZWNrT3V0RGF0ZSBpbnN0YW5jZW9mIERhdGUpXG4gICAgICAgICkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgIGBQYXNzZWQgaW52YWxpZCBjaGVjay1pbiBvciBjaGVjay1vdXQgZGF0ZSAtIGZyb20gXCIke3BhcmFtZXRlcnMuY2hlY2tJbkRhdGV9XCIgdG8gXCIke3BhcmFtZXRlcnMuY2hlY2tPdXREYXRlfVwiLmBcbiAgICAgICAgICApXG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fYXNzZXJ0RGF0ZXNBcmVDb3JyZWN0KFxuICAgICAgICAgIHBhcmFtZXRlcnMuY2hlY2tJbkRhdGUsXG4gICAgICAgICAgcGFyYW1ldGVycy5jaGVja091dERhdGVcbiAgICAgICAgKVxuXG4gICAgICAgIGlmIChcbiAgICAgICAgICBwYXJhbWV0ZXJzLnByaWNlTGltaXQgIT0gbnVsbCAmJlxuICAgICAgICAgIChpc05hTihwYXJhbWV0ZXJzLnByaWNlTGltaXQpIHx8ICFpc0Zpbml0ZShwYXJhbWV0ZXJzLnByaWNlTGltaXQpKVxuICAgICAgICApIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICBgUGFzc2VkIGludmFsaWQgcHJpY2UgbGltaXQgLSBcIiR7cGFyYW1ldGVycy5wcmljZUxpbWl0fVwiLmBcbiAgICAgICAgICApXG4gICAgICAgIH1cblxuICAgICAgICBsZXQgZmxhdHMgPSB0aGlzLmRhdGFiYXNlXG5cbiAgICAgICAgaWYgKHBhcmFtZXRlcnMucHJpY2VMaW1pdCAhPSBudWxsKSB7XG4gICAgICAgICAgZmxhdHMgPSBmbGF0cy5maWx0ZXIoKGZsYXQpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBmbGF0LnByaWNlIDw9IHBhcmFtZXRlcnMucHJpY2VMaW1pdFxuICAgICAgICAgIH0pXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBkYXRlUmFuZ2UgPSB0aGlzLl9nZW5lcmF0ZURhdGVSYW5nZShcbiAgICAgICAgICBwYXJhbWV0ZXJzLmNoZWNrSW5EYXRlLFxuICAgICAgICAgIHBhcmFtZXRlcnMuY2hlY2tPdXREYXRlXG4gICAgICAgIClcbiAgICAgICAgZmxhdHMgPSBmbGF0cy5maWx0ZXIoKGZsYXQpID0+IHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5fYXJlQWxsRGF0ZXNBdmFpbGFibGUoZmxhdCwgZGF0ZVJhbmdlKVxuICAgICAgICB9KVxuXG4gICAgICAgIGZsYXRzID0gZmxhdHMubWFwKChmbGF0KSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuX2Zvcm1hdEZsYXRPYmplY3QoZmxhdCwgZGF0ZVJhbmdlLmxlbmd0aCAtIDEpXG4gICAgICAgIH0pXG5cbiAgICAgICAgcmVzb2x2ZShmbGF0cylcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIHJlamVjdChlcnJvcilcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgLyoqXG4gICAqIEJvb2sgZmxhdC5cbiAgICpcbiAgICogQHBhcmFtIHtudW1iZXJ9IGZsYXRJZFxuICAgKiBAcGFyYW0ge0RhdGV9IGNoZWNrSW5EYXRlXG4gICAqIEBwYXJhbSB7RGF0ZX0gY2hlY2tPdXREYXRlXG4gICAqIEByZXR1cm5zIHtudW1iZXJ9XG4gICAqL1xuICBib29rKGZsYXRJZCwgY2hlY2tJbkRhdGUsIGNoZWNrT3V0RGF0ZSkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBmbGF0ID0gdGhpcy5kYXRhYmFzZS5maW5kKChpdGVtKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIGl0ZW0uaWQgPT09IGZsYXRJZFxuICAgICAgICB9KVxuXG4gICAgICAgIGlmIChmbGF0ID09IG51bGwpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RoZXJlIGlzIG5vIGZsYXQgd2l0aCBJRCBcIicgKyBmbGF0SWQgKyAnXCIuJylcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9hc3NlcnREYXRlc0FyZUNvcnJlY3QoY2hlY2tJbkRhdGUsIGNoZWNrT3V0RGF0ZSlcblxuICAgICAgICBjb25zdCBkYXRlc1RvQm9vayA9IHRoaXMuX2dlbmVyYXRlRGF0ZVJhbmdlKGNoZWNrSW5EYXRlLCBjaGVja091dERhdGUpXG4gICAgICAgIGlmICghdGhpcy5fYXJlQWxsRGF0ZXNBdmFpbGFibGUoZmxhdCwgZGF0ZXNUb0Jvb2spKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgYEZsYXQgJHtmbGF0LmlkfSBpcyBub3QgYXZhaWxhYmxlIGZvciBkYXRlcyAke2RhdGVzVG9Cb29rLmpvaW4oXG4gICAgICAgICAgICAgICcsJ1xuICAgICAgICAgICAgKX0uYFxuICAgICAgICAgIClcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGJvb2tlZERhdGVzID0gZGF0ZXNUb0Jvb2subWFwKChkYXRlKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIGRhdGUuZ2V0VGltZSgpXG4gICAgICAgIH0pXG4gICAgICAgIGZsYXQuYm9va2VkRGF0ZXMucHVzaCguLi5ib29rZWREYXRlcylcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmRhdGFiYXNlLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgaWYgKHRoaXMuZGF0YWJhc2VbaV0uaWQgPT09IGZsYXQuaWQpIHtcbiAgICAgICAgICAgIHRoaXMuZGF0YWJhc2VbaV0gPSBmbGF0XG4gICAgICAgICAgICBicmVha1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0aGlzLl93cml0ZURhdGFiYXNlKHRoaXMuZGF0YWJhc2UpXG5cbiAgICAgICAgcmVzb2x2ZSh0aGlzLl9nZW5lcmF0ZVRyYW5zYWN0aW9uSWQoKSlcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIHJlamVjdChlcnJvcilcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgX2Fzc2VydERhdGVzQXJlQ29ycmVjdChjaGVja0luRGF0ZSwgY2hlY2tPdXREYXRlKSB7XG4gICAgY29uc3QgdG9kYXkgPSBuZXcgRGF0ZSgpXG4gICAgdGhpcy5fcmVzZXRUaW1lKHRvZGF5KVxuICAgIHRoaXMuX3Jlc2V0VGltZShjaGVja0luRGF0ZSlcbiAgICB0aGlzLl9yZXNldFRpbWUoY2hlY2tPdXREYXRlKVxuXG4gICAgY29uc3QgZGlmZlRvZGF5ID0gdGhpcy5fY2FsY3VsYXRlRGlmZmVyZW5jZUluRGF5cyh0b2RheSwgY2hlY2tJbkRhdGUpXG4gICAgaWYgKGRpZmZUb2RheSA8IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkNoZWNrLWluIGRhdGUgY2FuJ3QgYmUgaW4gdGhlIHBhc3QuXCIpXG4gICAgfVxuXG4gICAgY29uc3QgZGlmZkNoZWNrID0gdGhpcy5fY2FsY3VsYXRlRGlmZmVyZW5jZUluRGF5cyhcbiAgICAgIGNoZWNrSW5EYXRlLFxuICAgICAgY2hlY2tPdXREYXRlXG4gICAgKTtcbiAgICBpZiAoZGlmZkNoZWNrIDwgMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDaGVjay1vdXQgZGF0ZSBtdXN0IGJlIGdyYXRlciB0aGVuIGNoZWNrLWluIGRhdGUuJylcbiAgICB9XG4gIH1cblxuICBfcmVzZXRUaW1lKGRhdGUpIHtcbiAgICBkYXRlLnNldEhvdXJzKDApXG4gICAgZGF0ZS5zZXRNaW51dGVzKDApXG4gICAgZGF0ZS5zZXRTZWNvbmRzKDApXG4gICAgZGF0ZS5zZXRNaWxsaXNlY29uZHMoMClcbiAgfVxuXG4gIF9jYWxjdWxhdGVEaWZmZXJlbmNlSW5EYXlzKHN0YXJ0RGF0ZSwgZW5kRGF0ZSkge1xuICAgIGNvbnN0IGRpZmZlcmVuY2UgPSBlbmREYXRlLmdldFRpbWUoKSAtIHN0YXJ0RGF0ZS5nZXRUaW1lKClcblxuICAgIHJldHVybiBNYXRoLmZsb29yKGRpZmZlcmVuY2UgLyAoMTAwMCAqIDYwICogNjAgKiAyNCkpXG4gIH1cblxuICBfZ2VuZXJhdGVEYXRlUmFuZ2UoZnJvbSwgdG8pIHtcbiAgICBjb25zdCBkYXRlcyA9IFtdXG4gICAgY29uc3QgZGlmZmVyZW5jZUluRGF5cyA9IHRoaXMuX2NhbGN1bGF0ZURpZmZlcmVuY2VJbkRheXMoZnJvbSwgdG8pXG5cbiAgICBkYXRlcy5wdXNoKG5ldyBEYXRlKGZyb20uZ2V0RnVsbFllYXIoKSwgZnJvbS5nZXRNb250aCgpLCBmcm9tLmdldERhdGUoKSkpXG4gICAgZm9yIChsZXQgaSA9IDE7IGkgPD0gZGlmZmVyZW5jZUluRGF5czsgaSsrKSB7XG4gICAgICBkYXRlcy5wdXNoKFxuICAgICAgICBuZXcgRGF0ZShmcm9tLmdldEZ1bGxZZWFyKCksIGZyb20uZ2V0TW9udGgoKSwgZnJvbS5nZXREYXRlKCkgKyBpKVxuICAgICAgKVxuICAgIH1cblxuICAgIHJldHVybiBkYXRlc1xuICB9XG5cbiAgX2dlbmVyYXRlVHJhbnNhY3Rpb25JZCA9ICgpID0+IHtcbiAgICBjb25zdCBtaW4gPSAxMDAwXG4gICAgY29uc3QgbWF4ID0gOTk5OVxuICAgIGNvbnN0IG51bSA9IE1hdGgucmFuZG9tKCkgKiAobWF4IC0gbWluKSArIG1pblxuXG4gICAgcmV0dXJuIE1hdGguZmxvb3IobnVtKVxuICB9XG5cbiAgX2FyZUFsbERhdGVzQXZhaWxhYmxlKGZsYXQsIGRhdGVSYW5nZSkge1xuICAgIHJldHVybiBkYXRlUmFuZ2UuZXZlcnkoKGRhdGUpID0+IHtcbiAgICAgIHJldHVybiAhZmxhdC5ib29rZWREYXRlcy5pbmNsdWRlcyhkYXRlLmdldFRpbWUoKSlcbiAgICB9KTtcbiAgfVxuXG4gIF9mb3JtYXRGbGF0T2JqZWN0KGZsYXQsIG5pZ2h0TnVtYmVyKSB7XG4gICAgY29uc3QgZm9ybWF0dGVkRmxhdCA9IE9iamVjdC5hc3NpZ24oe30sIGZsYXQpXG5cbiAgICBmb3JtYXR0ZWRGbGF0LnBob3RvcyA9IGZvcm1hdHRlZEZsYXQucGhvdG9zLm1hcCgocGhvdG9VcmwpID0+IHtcbiAgICAgIHJldHVybiBgaHR0cDovL2xvY2FsaG9zdDoke2JhY2tlbmRQb3J0fS9pbWcvJHtwaG90b1VybH1gXG4gICAgfSlcblxuICAgIGlmIChuaWdodE51bWJlciAhPSBudWxsKSB7XG4gICAgICBmb3JtYXR0ZWRGbGF0LnRvdGFsUHJpY2UgPSBuaWdodE51bWJlciAqIGZvcm1hdHRlZEZsYXQucHJpY2VcbiAgICAgIGRlbGV0ZSBmb3JtYXR0ZWRGbGF0LnByaWNlXG4gICAgfVxuXG4gICAgcmV0dXJuIGZvcm1hdHRlZEZsYXRcbiAgfVxuXG4gIF9yZWFkRGF0YWJhc2UoKSB7XG4gICAgY29uc3QgZGF0YSA9IHdpbmRvdy5sb2NhbFN0b3JhZ2UuZ2V0SXRlbShsb2NhbFN0b3JhZ2VLZXkpXG5cbiAgICBpZiAoZGF0YSA9PSBudWxsKSB7XG4gICAgICByZXR1cm4gZGF0YVxuICAgIH1cblxuICAgIHJldHVybiBKU09OLnBhcnNlKGRhdGEpXG4gIH1cblxuICBfd3JpdGVEYXRhYmFzZShkYXRhYmFzZSkge1xuICAgIHdpbmRvdy5sb2NhbFN0b3JhZ2Uuc2V0SXRlbShsb2NhbFN0b3JhZ2VLZXksIEpTT04uc3RyaW5naWZ5KGRhdGFiYXNlKSlcbiAgfVxuXG4gIF9zeW5jRGF0YWJhc2UoZGF0YWJhc2UpIHtcbiAgICB0aGlzLl93cml0ZURhdGFiYXNlKGRhdGFiYXNlKVxuICAgIHRoaXMuZGF0YWJhc2UgPSB0aGlzLl9yZWFkRGF0YWJhc2UoKVxuICB9XG59XG4iXX0=
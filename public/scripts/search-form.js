import { renderBlock } from './lib.js';
import { renderSearchResultsBlock } from './search-results.js';
import { isHomyAPISource, isFlatRentSource, createSource } from './sources.js';
export function isHomyAPISearchParameters(parameters) {
    return 'coordinates' in parameters;
}
export function isIFlatRentSearchParameters(parameters) {
    return 'city' in parameters;
}
export function isISearchFromData(object) {
    return ('city' in object &&
        'coordinates' in object &&
        'checkIn' in object &&
        'checkOut' in object &&
        'sources' in object);
}
export function getSearchFormData(id) {
    const searchForm = document.getElementById(id);
    if (!(searchForm instanceof HTMLFormElement))
        return;
    const formValues = new FormData(searchForm).entries();
    const formData = {};
    const sources = [];
    for (const [key, value] of formValues) {
        switch (key) {
            case 'checkIn':
            case 'checkOut':
                formData[key] = new Date(value.toString()).getTime();
                break;
            case 'price':
                formData[key] = value != '' ? Number(value.toString()) : null;
                break;
            case 'provider':
                if (value === 'Homy-API' || value === 'Flat-Rent-SDK') {
                    sources.push(createSource(value));
                    formData['sources'] = sources;
                }
                break;
            default:
                formData[key] = value.toString();
        }
    }
    if (isISearchFromData(formData))
        return formData;
}
export function convertFlatRentToIPlace(data) {
    const convert = (data) => {
        const { id, title, details, photos, bookedDates, totalPrice } = data;
        const source = 'Flat-Rent-SDK';
        return {
            id,
            source,
            bookedDates,
            name: title,
            description: details,
            price: totalPrice,
            image: photos[0],
        };
    };
    if (Array.isArray(data))
        return data.map(convert);
    return convert(data);
}
export async function searchInSource(source, parameters) {
    if (isHomyAPISource(source) && isHomyAPISearchParameters(parameters)) {
        const data = await source.api.search(parameters);
        if (data instanceof Error) {
            console.error(data.message);
            return;
        }
        return data;
    }
    if (isFlatRentSource(source) && isIFlatRentSearchParameters(parameters)) {
        const data = await source.api.search(parameters);
        if (data instanceof Error) {
            console.error(data.message);
            return;
        }
        const convertedData = convertFlatRentToIPlace(data);
        if (!Array.isArray(convertedData))
            return;
        return convertedData;
    }
}
export async function searchPlaceHandler(event, timer) {
    event.preventDefault();
    const fromId = 'search-form';
    const { city, coordinates, checkIn, checkOut, price, sources } = getSearchFormData(fromId);
    let places = [];
    for (const source of sources) {
        let parameters;
        switch (source.name) {
            case 'Homy-API': {
                parameters = {
                    coordinates,
                    checkInDate: checkIn,
                    checkOutDate: checkOut,
                };
                if (price != null)
                    parameters.maxPrice = price;
                break;
            }
            case 'Flat-Rent-SDK': {
                parameters = {
                    city,
                    checkInDate: new Date(checkIn),
                    checkOutDate: new Date(checkOut),
                    priceLimit: price,
                };
                break;
            }
            default:
        }
        const searchResult = await searchInSource(source, parameters);
        if (searchResult != null)
            places = [...places, ...searchResult];
    }
    renderSearchResultsBlock(places, sources);
    if (timer.id != null)
        timer.stop();
    timer.start(3e5);
}
export function checkProviderHandler(checkbox, checkboxes) {
    for (const checkbox of checkboxes) {
        if (checkbox instanceof HTMLInputElement && checkbox.checked)
            return;
    }
    checkbox.checked = !checkbox.checked;
}
export function renderSearchFormBlock(timer, arrivalDate, departureDate) {
    const ONE_DAY = 1;
    const TWO_DAY = 2;
    const TWO_MONTH = 2;
    const homy = 'Homy-API';
    const flatRent = 'Flat-Rent-SDK';
    const nowDate = new Date();
    const todayDate = new Date(nowDate.getFullYear(), nowDate.getMonth(), nowDate.getDate());
    const minDate = todayDate;
    const maxDate = getDateFromCurrent(todayDate, TWO_MONTH);
    const checkInDateValid = arrivalDate && arrivalDate >= minDate;
    const checkOutDateValid = departureDate && departureDate <= maxDate;
    const defaultCheckInDate = addDays(todayDate, ONE_DAY);
    const defaultCheckOutDate = checkInDateValid ? addDays(arrivalDate, TWO_DAY) : addDays(defaultCheckInDate, TWO_DAY);
    const minDateStr = getDateString(minDate);
    const maxDateStr = getDateString(maxDate);
    const checkInDateStr = checkInDateValid ? getDateString(arrivalDate) : getDateString(defaultCheckInDate);
    const checkOutDateStr = checkOutDateValid ? getDateString(departureDate) : getDateString(defaultCheckOutDate);
    renderBlock('search-form-block', `
     <form id="search-form">
      <fieldset class="search-fieldset">
        <div class="row">
          <div>
            <label for="city">Город</label>
            <input id="city" type="text" value="Санкт-Петербург" name="city"/>
            <input type="hidden" value="59.9386,30.3141" name="coordinates" />
          </div>
          <div class="providers">
            <label><input type="checkbox" name="provider" value="${homy}" checked /> Homy</label>
            <label><input type="checkbox" name="provider" value="${flatRent}" checked /> FlatRent</label>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="check-in-date">Дата заезда</label>
            <input
              id="check-in-date"
              type="date"
              value="${checkInDateStr}"
              min="${minDateStr}"
              max="${maxDateStr}"
              name="checkIn"
            />
          </div>
          <div>
            <label for="check-out-date">Дата выезда</label>
            <input
              id="check-out-date"
              type="date"
              value="${checkOutDateStr}"
              min="${minDateStr}"
              max="${maxDateStr}"
              name="checkOut"
            />
          </div>
          <div>
            <label for="max-price">Макс. цена суток</label>
            <input id="max-price" type="text" value="" name="price" class="max-price" />
          </div>
          <div>
            <button class="search-form-button">Найти</button>
          </div>
        </div>
      </fieldset>
    </form>
    `);
    const searchForm = document.getElementById('search-form');
    searchForm.addEventListener('submit', (event) => searchPlaceHandler(event, timer));
    const checkboxProvider = document.querySelectorAll('input[name="provider"]');
    checkboxProvider.forEach((checkbox) => checkbox.addEventListener('click', (event) => {
        const target = event.target;
        if (target instanceof HTMLInputElement) {
            checkProviderHandler(target, checkboxProvider);
        }
    }));
}
function addDays(date, countDays) {
    const copyDate = new Date(date);
    copyDate.setDate(copyDate.getDate() + countDays);
    return copyDate;
}
function getDateFromCurrent(date, monthLimit, day) {
    if (!day)
        day = 0;
    const copyDate = new Date(date);
    copyDate.setMonth(copyDate.getMonth() + monthLimit);
    copyDate.setDate(day);
    return copyDate;
}
function getDateString(date) {
    const YEAR_LENGTH = 4;
    const MONTH_LENGTH = 2;
    const DAY_LENGTH = 2;
    const year = String(date.getFullYear()).padStart(YEAR_LENGTH, '0');
    const month = String(date.getMonth() + 1).padStart(MONTH_LENGTH, '0');
    const day = String(date.getDate()).padStart(DAY_LENGTH, '0');
    return `${year}-${month}-${day}`;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoLWZvcm0uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvc2VhcmNoLWZvcm0udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFVBQVUsQ0FBQTtBQUN0QyxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQTtBQUs5RCxPQUFPLEVBQXNCLGVBQWUsRUFBRSxnQkFBZ0IsRUFBRSxZQUFZLEVBQUMsTUFBTSxjQUFjLENBQUE7QUFLakcsTUFBTSxVQUFVLHlCQUF5QixDQUN2QyxVQUE0QjtJQUU1QixPQUFPLGFBQWEsSUFBSSxVQUFVLENBQUE7QUFDcEMsQ0FBQztBQUVELE1BQU0sVUFBVSwyQkFBMkIsQ0FDekMsVUFBNEI7SUFFNUIsT0FBTyxNQUFNLElBQUksVUFBVSxDQUFBO0FBQzdCLENBQUM7QUFXRCxNQUFNLFVBQVUsaUJBQWlCLENBQy9CLE1BQWdDO0lBRWhDLE9BQU8sQ0FDTCxNQUFNLElBQUksTUFBTTtRQUNoQixhQUFhLElBQUksTUFBTTtRQUN2QixTQUFTLElBQUksTUFBTTtRQUNuQixVQUFVLElBQUksTUFBTTtRQUNwQixTQUFTLElBQUksTUFBTSxDQUNwQixDQUFBO0FBQ0gsQ0FBQztBQUVELE1BQU0sVUFBVSxpQkFBaUIsQ0FBQyxFQUFVO0lBQzFDLE1BQU0sVUFBVSxHQUFHLFFBQVEsQ0FBQyxjQUFjLENBQUMsRUFBRSxDQUFDLENBQUE7SUFFOUMsSUFBSSxDQUFDLENBQUMsVUFBVSxZQUFZLGVBQWUsQ0FBQztRQUFFLE9BQU07SUFFcEQsTUFBTSxVQUFVLEdBQUcsSUFBSSxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUE7SUFDckQsTUFBTSxRQUFRLEdBQTZCLEVBQUUsQ0FBQTtJQUM3QyxNQUFNLE9BQU8sR0FBYyxFQUFFLENBQUE7SUFFN0IsS0FBSyxNQUFNLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxJQUFJ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QUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsV0FBVyxFQUFFLEdBQUcsQ0FBQyxDQUFBO0lBQ2xFLE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLFlBQVksRUFBRSxHQUFHLENBQUMsQ0FBQTtJQUNyRSxNQUFNLEdBQUcsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLFVBQVUsRUFBRSxHQUFHLENBQUMsQ0FBQTtJQUU1RCxPQUFPLEdBQUcsSUFBSSxJQUFJLEtBQUssSUFBSSxHQUFHLEVBQUUsQ0FBQTtBQUNsQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcmVuZGVyQmxvY2sgfSBmcm9tICcuL2xpYi5qcydcbmltcG9ydCB7IHJlbmRlclNlYXJjaFJlc3VsdHNCbG9jayB9IGZyb20gJy4vc2VhcmNoLXJlc3VsdHMuanMnXG5pbXBvcnQgeyBTZWFyY2hGb3JtSWQgfSBmcm9tICcuL3R5cGVzL3R5cGVzLmpzJ1xuaW1wb3J0IHsgVGltZXIgfSBmcm9tICcuL3RpbWVyLmpzJ1xuaW1wb3J0IHtJRmxhdFJlbnRTZWFyY2hQYXJhbWV0ZXJzLCBJRm9ybWF0dGVkRmxhdFJlbnRQbGFjZX0gZnJvbSAnLi9TREsvZmxhdC1yZW50LXNkay5qcydcbmltcG9ydCB7IEhvbXlBUElTZWFyY2hQYXJhbWV0ZXJzIH0gZnJvbSAnLi9BUEkvaG9teS1hcGkuanMnXG5pbXBvcnQge0lTb3VyY2UsIFNvdXJjZU5hbWUsIGlzSG9teUFQSVNvdXJjZSwgaXNGbGF0UmVudFNvdXJjZSwgY3JlYXRlU291cmNlfSBmcm9tICcuL3NvdXJjZXMuanMnXG5pbXBvcnQgeyBJUGxhY2UgfSBmcm9tICcuL3BsYWNlLmpzJ1xuXG5leHBvcnQgdHlwZSBTZWFyY2hQYXJhbWV0ZXJzID0gfCBIb215QVBJU2VhcmNoUGFyYW1ldGVycyB8IElGbGF0UmVudFNlYXJjaFBhcmFtZXRlcnNcblxuZXhwb3J0IGZ1bmN0aW9uIGlzSG9teUFQSVNlYXJjaFBhcmFtZXRlcnMoXG4gIHBhcmFtZXRlcnM6IFNlYXJjaFBhcmFtZXRlcnNcbik6IHBhcmFtZXRlcnMgaXMgSG9teUFQSVNlYXJjaFBhcmFtZXRlcnMge1xuICByZXR1cm4gJ2Nvb3JkaW5hdGVzJyBpbiBwYXJhbWV0ZXJzXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0lGbGF0UmVudFNlYXJjaFBhcmFtZXRlcnMoXG4gIHBhcmFtZXRlcnM6IFNlYXJjaFBhcmFtZXRlcnNcbik6IHBhcmFtZXRlcnMgaXMgSUZsYXRSZW50U2VhcmNoUGFyYW1ldGVycyB7XG4gIHJldHVybiAnY2l0eScgaW4gcGFyYW1ldGVyc1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIElTZWFyY2hGb3JtRGF0YSB7XG4gIGNpdHk6IHN0cmluZztcbiAgY29vcmRpbmF0ZXM6IHN0cmluZztcbiAgY2hlY2tJbjogbnVtYmVyO1xuICBjaGVja091dDogbnVtYmVyO1xuICBwcmljZT86IG51bWJlcjtcbiAgc291cmNlczogSVNvdXJjZVtdXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0lTZWFyY2hGcm9tRGF0YShcbiAgb2JqZWN0OiBQYXJ0aWFsPElTZWFyY2hGb3JtRGF0YT5cbik6IG9iamVjdCBpcyBJU2VhcmNoRm9ybURhdGEge1xuICByZXR1cm4gKFxuICAgICdjaXR5JyBpbiBvYmplY3QgJiZcbiAgICAnY29vcmRpbmF0ZXMnIGluIG9iamVjdCAmJlxuICAgICdjaGVja0luJyBpbiBvYmplY3QgJiZcbiAgICAnY2hlY2tPdXQnIGluIG9iamVjdCAmJlxuICAgICdzb3VyY2VzJyBpbiBvYmplY3RcbiAgKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0U2VhcmNoRm9ybURhdGEoaWQ6IHN0cmluZyk6IElTZWFyY2hGb3JtRGF0YSB8IG51bGwge1xuICBjb25zdCBzZWFyY2hGb3JtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpXG5cbiAgaWYgKCEoc2VhcmNoRm9ybSBpbnN0YW5jZW9mIEhUTUxGb3JtRWxlbWVudCkpIHJldHVyblxuXG4gIGNvbnN0IGZvcm1WYWx1ZXMgPSBuZXcgRm9ybURhdGEoc2VhcmNoRm9ybSkuZW50cmllcygpXG4gIGNvbnN0IGZvcm1EYXRhOiBQYXJ0aWFsPElTZWFyY2hGb3JtRGF0YT4gPSB7fVxuICBjb25zdCBzb3VyY2VzOiBJU291cmNlW10gPSBbXVxuXG4gIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIGZvcm1WYWx1ZXMpIHtcbiAgICBzd2l0Y2ggKGtleSkge1xuICAgICAgY2FzZSAnY2hlY2tJbic6XG4gICAgICBjYXNlICdjaGVja091dCc6XG4gICAgICAgIGZvcm1EYXRhW2tleV0gPSBuZXcgRGF0ZSh2YWx1ZS50b1N0cmluZygpKS5nZXRUaW1lKClcbiAgICAgICAgYnJlYWtcbiAgICAgIGNhc2UgJ3ByaWNlJzpcbiAgICAgICAgZm9ybURhdGFba2V5XSA9IHZhbHVlICE9ICcnID8gTnVtYmVyKHZhbHVlLnRvU3RyaW5nKCkpIDogbnVsbFxuICAgICAgICBicmVha1xuICAgICAgY2FzZSAncHJvdmlkZXInOlxuICAgICAgICBpZiAodmFsdWUgPT09ICdIb215LUFQSScgfHwgdmFsdWUgPT09ICdGbGF0LVJlbnQtU0RLJykge1xuICAgICAgICAgIHNvdXJjZXMucHVzaChjcmVhdGVTb3VyY2UodmFsdWUpKVxuICAgICAgICAgIGZvcm1EYXRhWydzb3VyY2VzJ10gPSBzb3VyY2VzXG4gICAgICAgIH1cbiAgICAgICAgYnJlYWtcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIGZvcm1EYXRhW2tleV0gPSB2YWx1ZS50b1N0cmluZygpXG4gICAgfVxuICB9XG5cbiAgaWYgKGlzSVNlYXJjaEZyb21EYXRhKGZvcm1EYXRhKSkgcmV0dXJuIGZvcm1EYXRhXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb252ZXJ0RmxhdFJlbnRUb0lQbGFjZShcbiAgZGF0YTogSUZvcm1hdHRlZEZsYXRSZW50UGxhY2UgfCBJRm9ybWF0dGVkRmxhdFJlbnRQbGFjZVtdXG4pOiBJUGxhY2UgfCBJUGxhY2VbXSB7XG4gIGNvbnN0IGNvbnZlcnQgPSAoZGF0YTogSUZvcm1hdHRlZEZsYXRSZW50UGxhY2UpID0+IHtcbiAgICBjb25zdCB7IGlkLCB0aXRsZSwgZGV0YWlscywgcGhvdG9zLCBib29rZWREYXRlcywgdG90YWxQcmljZSB9ID0gZGF0YVxuICAgIGNvbnN0IHNvdXJjZTogU291cmNlTmFtZSA9ICdGbGF0LVJlbnQtU0RLJ1xuICAgIHJldHVybiB7XG4gICAgICBpZCxcbiAgICAgIHNvdXJjZSxcbiAgICAgIGJvb2tlZERhdGVzLFxuICAgICAgbmFtZTogdGl0bGUsXG4gICAgICBkZXNjcmlwdGlvbjogZGV0YWlscyxcbiAgICAgIHByaWNlOiB0b3RhbFByaWNlLFxuICAgICAgaW1hZ2U6IHBob3Rvc1swXSxcbiAgICB9XG4gIH1cblxuICBpZiAoQXJyYXkuaXNBcnJheShkYXRhKSkgcmV0dXJuIGRhdGEubWFwKGNvbnZlcnQpXG5cbiAgcmV0dXJuIGNvbnZlcnQoZGF0YSlcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHNlYXJjaEluU291cmNlKFxuICBzb3VyY2U6IElTb3VyY2UsXG4gIHBhcmFtZXRlcnM6IFNlYXJjaFBhcmFtZXRlcnNcbik6IFByb21pc2U8SVBsYWNlW10gfCBudWxsPiB7XG4gIGlmIChpc0hvbXlBUElTb3VyY2Uoc291cmNlKSAmJiBpc0hvbXlBUElTZWFyY2hQYXJhbWV0ZXJzKHBhcmFtZXRlcnMpKSB7XG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IHNvdXJjZS5hcGkuc2VhcmNoKHBhcmFtZXRlcnMpXG5cbiAgICBpZiAoZGF0YSBpbnN0YW5jZW9mIEVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKGRhdGEubWVzc2FnZSlcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIHJldHVybiBkYXRhXG4gIH1cblxuICBpZiAoaXNGbGF0UmVudFNvdXJjZShzb3VyY2UpICYmIGlzSUZsYXRSZW50U2VhcmNoUGFyYW1ldGVycyhwYXJhbWV0ZXJzKSkge1xuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBzb3VyY2UuYXBpLnNlYXJjaChwYXJhbWV0ZXJzKVxuXG4gICAgaWYgKGRhdGEgaW5zdGFuY2VvZiBFcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihkYXRhLm1lc3NhZ2UpXG4gICAgICByZXR1cm5cbiAgICB9XG5cbiAgICBjb25zdCBjb252ZXJ0ZWREYXRhID0gY29udmVydEZsYXRSZW50VG9JUGxhY2UoZGF0YSlcblxuICAgIGlmICghQXJyYXkuaXNBcnJheShjb252ZXJ0ZWREYXRhKSkgcmV0dXJuXG5cbiAgICByZXR1cm4gY29udmVydGVkRGF0YVxuICB9XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBzZWFyY2hQbGFjZUhhbmRsZXIoXG4gIGV2ZW50OiBFdmVudCxcbiAgdGltZXI/OiBUaW1lclxuKTogUHJvbWlzZTx2b2lkPiB7XG4gIGV2ZW50LnByZXZlbnREZWZhdWx0KClcblxuICBjb25zdCBmcm9tSWQ6IFNlYXJjaEZvcm1JZCA9ICdzZWFyY2gtZm9ybSdcbiAgY29uc3QgeyBjaXR5LCBjb29yZGluYXRlcywgY2hlY2tJbiwgY2hlY2tPdXQsIHByaWNlLCBzb3VyY2VzIH0gPSBnZXRTZWFyY2hGb3JtRGF0YShmcm9tSWQpXG5cbiAgbGV0IHBsYWNlczogSVBsYWNlW10gPSBbXVxuXG4gIGZvciAoY29uc3Qgc291cmNlIG9mIHNvdXJjZXMpIHtcbiAgICBsZXQgcGFyYW1ldGVyczogU2VhcmNoUGFyYW1ldGVyc1xuXG4gICAgc3dpdGNoIChzb3VyY2UubmFtZSkge1xuICAgICAgY2FzZSAnSG9teS1BUEknOiB7XG4gICAgICAgIHBhcmFtZXRlcnMgPSB7XG4gICAgICAgICAgY29vcmRpbmF0ZXMsXG4gICAgICAgICAgY2hlY2tJbkRhdGU6IGNoZWNrSW4sXG4gICAgICAgICAgY2hlY2tPdXREYXRlOiBjaGVja091dCxcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChwcmljZSAhPSBudWxsKSBwYXJhbWV0ZXJzLm1heFByaWNlID0gcHJpY2VcblxuICAgICAgICBicmVha1xuICAgICAgfVxuICAgICAgY2FzZSAnRmxhdC1SZW50LVNESyc6IHtcbiAgICAgICAgcGFyYW1ldGVycyA9IHtcbiAgICAgICAgICBjaXR5LFxuICAgICAgICAgIGNoZWNrSW5EYXRlOiBuZXcgRGF0ZShjaGVja0luKSxcbiAgICAgICAgICBjaGVja091dERhdGU6IG5ldyBEYXRlKGNoZWNrT3V0KSxcbiAgICAgICAgICBwcmljZUxpbWl0OiBwcmljZSxcbiAgICAgICAgfVxuICAgICAgICBicmVha1xuICAgICAgfVxuICAgICAgZGVmYXVsdDpcbiAgICB9XG5cbiAgICBjb25zdCBzZWFyY2hSZXN1bHQgPSBhd2FpdCBzZWFyY2hJblNvdXJjZShzb3VyY2UsIHBhcmFtZXRlcnMpXG4gICAgaWYgKHNlYXJjaFJlc3VsdCAhPSBudWxsKSBwbGFjZXMgPSBbLi4ucGxhY2VzLCAuLi5zZWFyY2hSZXN1bHRdXG4gIH1cblxuICByZW5kZXJTZWFyY2hSZXN1bHRzQmxvY2socGxhY2VzLCBzb3VyY2VzKVxuICBpZiAodGltZXIuaWQgIT0gbnVsbCkgdGltZXIuc3RvcCgpXG4gIHRpbWVyLnN0YXJ0KDNlNSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNoZWNrUHJvdmlkZXJIYW5kbGVyKFxuICBjaGVja2JveDogSFRNTElucHV0RWxlbWVudCxcbiAgY2hlY2tib3hlczogTm9kZUxpc3RPZjxFbGVtZW50PlxuKTogdm9pZCB7XG4gIGZvciAoY29uc3QgY2hlY2tib3ggb2YgY2hlY2tib3hlcykge1xuICAgIGlmIChjaGVja2JveCBpbnN0YW5jZW9mIEhUTUxJbnB1dEVsZW1lbnQgJiYgY2hlY2tib3guY2hlY2tlZCkgcmV0dXJuXG4gIH1cbiAgY2hlY2tib3guY2hlY2tlZCA9ICFjaGVja2JveC5jaGVja2VkXG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZW5kZXJTZWFyY2hGb3JtQmxvY2sgKFxuICB0aW1lcj86IFRpbWVyLFxuICBhcnJpdmFsRGF0ZSA/IDogRGF0ZSxcbiAgZGVwYXJ0dXJlRGF0ZSA/IDogRGF0ZSxcbikgOiB2b2lkIHtcbiAgY29uc3QgT05FX0RBWSA9IDFcbiAgY29uc3QgVFdPX0RBWSA9IDJcbiAgY29uc3QgVFdPX01PTlRIID0gMlxuICBjb25zdCBob215OiBTb3VyY2VOYW1lID0gJ0hvbXktQVBJJ1xuICBjb25zdCBmbGF0UmVudDogU291cmNlTmFtZSA9ICdGbGF0LVJlbnQtU0RLJ1xuXG4gIGNvbnN0IG5vd0RhdGUgPSBuZXcgRGF0ZSgpXG4gIGNvbnN0IHRvZGF5RGF0ZSA9IG5ldyBEYXRlKFxuICAgIG5vd0RhdGUuZ2V0RnVsbFllYXIoKSxcbiAgICBub3dEYXRlLmdldE1vbnRoKCksXG4gICAgbm93RGF0ZS5nZXREYXRlKClcbiAgKVxuXG4gIGNvbnN0IG1pbkRhdGUgPSB0b2RheURhdGVcbiAgY29uc3QgbWF4RGF0ZSA9IGdldERhdGVGcm9tQ3VycmVudCh0b2RheURhdGUsIFRXT19NT05USClcblxuICBjb25zdCBjaGVja0luRGF0ZVZhbGlkID0gYXJyaXZhbERhdGUgJiYgYXJyaXZhbERhdGUgPj0gbWluRGF0ZVxuICBjb25zdCBjaGVja091dERhdGVWYWxpZCA9IGRlcGFydHVyZURhdGUgJiYgZGVwYXJ0dXJlRGF0ZSA8PSBtYXhEYXRlXG5cbiAgY29uc3QgZGVmYXVsdENoZWNrSW5EYXRlID0gYWRkRGF5cyh0b2RheURhdGUsIE9ORV9EQVkpXG4gIGNvbnN0IGRlZmF1bHRDaGVja091dERhdGUgPSBjaGVja0luRGF0ZVZhbGlkID8gYWRkRGF5cyhhcnJpdmFsRGF0ZSwgVFdPX0RBWSkgOiBhZGREYXlzKGRlZmF1bHRDaGVja0luRGF0ZSwgVFdPX0RBWSlcblxuICBjb25zdCBtaW5EYXRlU3RyID0gZ2V0RGF0ZVN0cmluZyhtaW5EYXRlKVxuICBjb25zdCBtYXhEYXRlU3RyID0gZ2V0RGF0ZVN0cmluZyhtYXhEYXRlKVxuICBjb25zdCBjaGVja0luRGF0ZVN0ciA9IGNoZWNrSW5EYXRlVmFsaWQgPyBnZXREYXRlU3RyaW5nKGFycml2YWxEYXRlKSA6IGdldERhdGVTdHJpbmcoZGVmYXVsdENoZWNrSW5EYXRlKVxuICBjb25zdCBjaGVja091dERhdGVTdHIgPSBjaGVja091dERhdGVWYWxpZCA/IGdldERhdGVTdHJpbmcoZGVwYXJ0dXJlRGF0ZSkgOiBnZXREYXRlU3RyaW5nKGRlZmF1bHRDaGVja091dERhdGUpXG5cbiAgcmVuZGVyQmxvY2soXG4gICAgJ3NlYXJjaC1mb3JtLWJsb2NrJyxcbiAgICBgXG4gICAgIDxmb3JtIGlkPVwic2VhcmNoLWZvcm1cIj5cbiAgICAgIDxmaWVsZHNldCBjbGFzcz1cInNlYXJjaC1maWVsZHNldFwiPlxuICAgICAgICA8ZGl2IGNsYXNzPVwicm93XCI+XG4gICAgICAgICAgPGRpdj5cbiAgICAgICAgICAgIDxsYWJlbCBmb3I9XCJjaXR5XCI+0JPQvtGA0L7QtDwvbGFiZWw+XG4gICAgICAgICAgICA8aW5wdXQgaWQ9XCJjaXR5XCIgdHlwZT1cInRleHRcIiB2YWx1ZT1cItCh0LDQvdC60YIt0J/QtdGC0LXRgNCx0YPRgNCzXCIgbmFtZT1cImNpdHlcIi8+XG4gICAgICAgICAgICA8aW5wdXQgdHlwZT1cImhpZGRlblwiIHZhbHVlPVwiNTkuOTM4NiwzMC4zMTQxXCIgbmFtZT1cImNvb3JkaW5hdGVzXCIgLz5cbiAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICA8ZGl2IGNsYXNzPVwicHJvdmlkZXJzXCI+XG4gICAgICAgICAgICA8bGFiZWw+PGlucHV0IHR5cGU9XCJjaGVja2JveFwiIG5hbWU9XCJwcm92aWRlclwiIHZhbHVlPVwiJHtob215fVwiIGNoZWNrZWQgLz4gSG9teTwvbGFiZWw+XG4gICAgICAgICAgICA8bGFiZWw+PGlucHV0IHR5cGU9XCJjaGVja2JveFwiIG5hbWU9XCJwcm92aWRlclwiIHZhbHVlPVwiJHtmbGF0UmVudH1cIiBjaGVja2VkIC8+IEZsYXRSZW50PC9sYWJlbD5cbiAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgPC9kaXY+XG4gICAgICAgIDxkaXYgY2xhc3M9XCJyb3dcIj5cbiAgICAgICAgICA8ZGl2PlxuICAgICAgICAgICAgPGxhYmVsIGZvcj1cImNoZWNrLWluLWRhdGVcIj7QlNCw0YLQsCDQt9Cw0LXQt9C00LA8L2xhYmVsPlxuICAgICAgICAgICAgPGlucHV0XG4gICAgICAgICAgICAgIGlkPVwiY2hlY2staW4tZGF0ZVwiXG4gICAgICAgICAgICAgIHR5cGU9XCJkYXRlXCJcbiAgICAgICAgICAgICAgdmFsdWU9XCIke2NoZWNrSW5EYXRlU3RyfVwiXG4gICAgICAgICAgICAgIG1pbj1cIiR7bWluRGF0ZVN0cn1cIlxuICAgICAgICAgICAgICBtYXg9XCIke21heERhdGVTdHJ9XCJcbiAgICAgICAgICAgICAgbmFtZT1cImNoZWNrSW5cIlxuICAgICAgICAgICAgLz5cbiAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICA8ZGl2PlxuICAgICAgICAgICAgPGxhYmVsIGZvcj1cImNoZWNrLW91dC1kYXRlXCI+0JTQsNGC0LAg0LLRi9C10LfQtNCwPC9sYWJlbD5cbiAgICAgICAgICAgIDxpbnB1dFxuICAgICAgICAgICAgICBpZD1cImNoZWNrLW91dC1kYXRlXCJcbiAgICAgICAgICAgICAgdHlwZT1cImRhdGVcIlxuICAgICAgICAgICAgICB2YWx1ZT1cIiR7Y2hlY2tPdXREYXRlU3RyfVwiXG4gICAgICAgICAgICAgIG1pbj1cIiR7bWluRGF0ZVN0cn1cIlxuICAgICAgICAgICAgICBtYXg9XCIke21heERhdGVTdHJ9XCJcbiAgICAgICAgICAgICAgbmFtZT1cImNoZWNrT3V0XCJcbiAgICAgICAgICAgIC8+XG4gICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgPGRpdj5cbiAgICAgICAgICAgIDxsYWJlbCBmb3I9XCJtYXgtcHJpY2VcIj7QnNCw0LrRgS4g0YbQtdC90LAg0YHRg9GC0L7QujwvbGFiZWw+XG4gICAgICAgICAgICA8aW5wdXQgaWQ9XCJtYXgtcHJpY2VcIiB0eXBlPVwidGV4dFwiIHZhbHVlPVwiXCIgbmFtZT1cInByaWNlXCIgY2xhc3M9XCJtYXgtcHJpY2VcIiAvPlxuICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgIDxkaXY+XG4gICAgICAgICAgICA8YnV0dG9uIGNsYXNzPVwic2VhcmNoLWZvcm0tYnV0dG9uXCI+0J3QsNC50YLQuDwvYnV0dG9uPlxuICAgICAgICAgIDwvZGl2PlxuICAgICAgICA8L2Rpdj5cbiAgICAgIDwvZmllbGRzZXQ+XG4gICAgPC9mb3JtPlxuICAgIGBcbiAgKVxuICBjb25zdCBzZWFyY2hGb3JtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NlYXJjaC1mb3JtJylcbiAgc2VhcmNoRm9ybS5hZGRFdmVudExpc3RlbmVyKCdzdWJtaXQnLCAoZXZlbnQpID0+XG4gICAgc2VhcmNoUGxhY2VIYW5kbGVyKGV2ZW50LCB0aW1lcilcbiAgKVxuICBjb25zdCBjaGVja2JveFByb3ZpZGVyID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnaW5wdXRbbmFtZT1cInByb3ZpZGVyXCJdJylcblxuICBjaGVja2JveFByb3ZpZGVyLmZvckVhY2goKGNoZWNrYm94KSA9PlxuICAgIGNoZWNrYm94LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGV2ZW50KSA9PiB7XG4gICAgICBjb25zdCB0YXJnZXQgPSBldmVudC50YXJnZXRcbiAgICAgIGlmICh0YXJnZXQgaW5zdGFuY2VvZiBIVE1MSW5wdXRFbGVtZW50KSB7XG4gICAgICAgIGNoZWNrUHJvdmlkZXJIYW5kbGVyKHRhcmdldCwgY2hlY2tib3hQcm92aWRlcilcbiAgICAgIH1cbiAgICB9KVxuICApXG59XG5cbmZ1bmN0aW9uIGFkZERheXMoZGF0ZTogRGF0ZSwgY291bnREYXlzOiBudW1iZXIpOiBEYXRlIHtcbiAgY29uc3QgY29weURhdGUgPSBuZXcgRGF0ZShkYXRlKVxuICBjb3B5RGF0ZS5zZXREYXRlKGNvcHlEYXRlLmdldERhdGUoKSArIGNvdW50RGF5cylcblxuICByZXR1cm4gY29weURhdGVcbn1cblxuZnVuY3Rpb24gZ2V0RGF0ZUZyb21DdXJyZW50KFxuICBkYXRlOiBEYXRlLFxuICBtb250aExpbWl0OiBudW1iZXIsXG4gIGRheT86IG51bWJlclxuKTogRGF0ZSB7XG4gIGlmICghZGF5KSBkYXkgPSAwXG4gIGNvbnN0IGNvcHlEYXRlID0gbmV3IERhdGUoZGF0ZSlcbiAgY29weURhdGUuc2V0TW9udGgoY29weURhdGUuZ2V0TW9udGgoKSArIG1vbnRoTGltaXQpXG4gIGNvcHlEYXRlLnNldERhdGUoZGF5KVxuXG4gIHJldHVybiBjb3B5RGF0ZVxufVxuXG5mdW5jdGlvbiBnZXREYXRlU3RyaW5nKGRhdGU6IERhdGUpOiBzdHJpbmcge1xuICBjb25zdCBZRUFSX0xFTkdUSCA9IDRcbiAgY29uc3QgTU9OVEhfTEVOR1RIID0gMlxuICBjb25zdCBEQVlfTEVOR1RIID0gMlxuXG4gIGNvbnN0IHllYXIgPSBTdHJpbmcoZGF0ZS5nZXRGdWxsWWVhcigpKS5wYWRTdGFydChZRUFSX0xFTkdUSCwgJzAnKVxuICBjb25zdCBtb250aCA9IFN0cmluZyhkYXRlLmdldE1vbnRoKCkgKyAxKS5wYWRTdGFydChNT05USF9MRU5HVEgsICcwJylcbiAgY29uc3QgZGF5ID0gU3RyaW5nKGRhdGUuZ2V0RGF0ZSgpKS5wYWRTdGFydChEQVlfTEVOR1RILCAnMCcpXG5cbiAgcmV0dXJuIGAke3llYXJ9LSR7bW9udGh9LSR7ZGF5fWBcbn1cbiJdfQ==